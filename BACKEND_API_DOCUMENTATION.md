# RIA Hunter Backend API Documentation

## Status: ‚úÖ BACKEND IS FULLY WORKING

Last Updated: August 27, 2025  
Author: Backend AI Agent

---

## CRITICAL PRODUCTION ROUTING INFORMATION üö®

In production (https://ria-hunter.app), all API endpoints are accessible at:
```
/api/*
```

This follows standard Next.js API routing conventions.

---

## Core Endpoints

### 1. Session Status Endpoint ‚úÖ WORKING
**Endpoint:** `/api/session/status`  
**Method:** GET  
**Authentication:** Not required  
**Purpose:** Check remaining searches for demo/free tier users

**Example Request:**
```bash
curl https://ria-hunter.app/api/session/status
```

**Response:**
```json
{
  "searchesRemaining": 4,
  "searchesUsed": 1,
  "isSubscriber": false,
  "isAuthenticated": false,
  "totalAllowed": 5
}
```

**Important Notes:**
- Uses cookie-based session tracking (`rh_demo` cookie)
- Returns `-1` for `searchesRemaining` if user is a subscriber (unlimited)
- Cookie persists for 24 hours

---

### 2. Ask Endpoint (Main Search) ‚úÖ WORKING  
**Endpoint:** `/api/ask`  
**Method:** POST  
**Authentication:** Optional (affects rate limits)  
**Purpose:** Main AI-powered search endpoint

**Example Request:**
```bash
curl -X POST https://ria-hunter.app/api/ask \
  -H "Content-Type: application/json" \
  -d '{"query":"Show me the largest RIAs in St. Louis"}'
```

**Response Structure:**
```json
{
  "answer": "Natural language answer generated by AI",
  "sources": [
    {
      "crd_number": 423,
      "legal_name": "STIFEL, NICOLAUS & COMPANY, INCORPORATED",
      "city": "ST LOUIS",
      "state": "MO",
      "aum": 54000000000,
      "private_fund_count": 9,
      "private_fund_aum": 93479356739,
      "similarity": 0.85,
      "executives": [
        {
          "name": "Ronald James Kruszewski",
          "title": "Chairman and CEO"
        }
      ]
    }
  ],
  "metadata": {
    "searchStrategy": "semantic-first",
    "queryType": "superlative-largest",
    "confidence": 0.85,
    "searchesRemaining": 4,
    "searchesUsed": 1,
    "isAuthenticated": false,
    "isSubscriber": false,
    "requestId": "req-1234567890-abc"
  }
}
```

**Session Tracking:**
- ‚úÖ AUTOMATICALLY decrements search counter for non-subscribers
- ‚úÖ Sets/updates `rh_demo` cookie with search count
- ‚úÖ Returns 402 status when demo limit reached

---

### 3. Ask Stream Endpoint (SSE Streaming) ‚úÖ WORKING
**Endpoint:** `/api/ask-stream`  
**Method:** POST  
**Authentication:** Optional  
**Purpose:** Streaming version of search for real-time UI updates

**Example Request:**
```bash
curl -X POST https://ria-hunter.app/api/ask-stream \
  -H "Content-Type: application/json" \
  -H "Accept: text/event-stream" \
  -d '{"query":"largest RIAs in New York"}'
```

**Response:** Server-Sent Events (SSE) stream
```
data: {"type":"connected","metadata":{"remaining":4,"isSubscriber":false}}

data: {"token":"Based"}

data: {"token":" on"}

data: {"token":" the"}

data: {"type":"metadata","metadata":{"remaining":4,"isSubscriber":false}}

data: [DONE]
```

**Session Tracking:**
- ‚úÖ ALSO decrements search counter
- ‚úÖ Sets session cookie in response headers
- ‚úÖ Includes metadata in stream

---

## Search Features

### Semantic Search ‚úÖ WORKING
- Uses Vertex AI embeddings (768 dimensions)
- Searches through narrative descriptions of RIAs
- Falls back to structured search if semantic fails
- Properly handles location variants (St. Louis, Saint Louis, St Louis, etc.)

### Superlative Queries ‚úÖ WORKING  
- Handles "largest", "biggest", "top" queries
- Properly sorts by AUM
- Returns enriched data with executives

### Data Fields Available ‚úÖ CORRECT
The backend now returns the correct fields:
- `aum` - Total assets under management (NOT vc_aum)
- `private_fund_count` - Number of private funds
- `private_fund_aum` - Private fund assets
- `executives` - List of key executives with titles

---

## Cookie Management

### Demo Session Cookie
**Name:** `rh_demo`  
**Domain:** `.ria-hunter.app`  
**Duration:** 24 hours  
**Purpose:** Tracks free searches used

**Important for Frontend:**
- Must include `credentials: 'include'` in fetch calls
- Cookie is httpOnly, secure, sameSite=lax
- Automatically managed by browser

---

## Error Responses

### 402 - Payment Required (Demo Limit)
```json
{
  "error": "You've used your 5 free demo searches. Sign up for unlimited access.",
  "code": "DEMO_LIMIT_REACHED",
  "searchesUsed": 5,
  "searchesRemaining": 0,
  "upgradeRequired": true
}
```

### 400 - Bad Request
```json
{
  "error": "Query is required"
}
```

### 500 - Internal Server Error
```json
{
  "error": "Internal server error"
}
```

---

## Frontend Integration Guide

### Correct API Call Pattern
```javascript
// CORRECT - Use /_backend prefix in production
const API_BASE = process.env.NODE_ENV === 'production' 
  ? 'https://ria-hunter.app/api'
  : 'http://localhost:3000/api';

// Making a search request
const response = await fetch(`${API_BASE}/ask`, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    // Include auth header if user is logged in
    ...(authToken && { 'Authorization': `Bearer ${authToken}` })
  },
  credentials: 'include', // CRITICAL: Include cookies for session tracking
  body: JSON.stringify({ query: userQuery })
});
```

### Session Status Check
```javascript
// Check remaining searches before allowing query
const statusResponse = await fetch(`${API_BASE}/session/status`, {
  credentials: 'include' // Include cookies
});
const status = await statusResponse.json();

if (status.searchesRemaining === 0 && !status.isSubscriber) {
  // Show upgrade prompt
}
```

### Streaming Implementation
```javascript
const response = await fetch(`${API_BASE}/ask-stream`, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Accept': 'text/event-stream'
  },
  credentials: 'include',
  body: JSON.stringify({ query })
});

const reader = response.body.getReader();
const decoder = new TextDecoder();

while (true) {
  const { done, value } = await reader.read();
  if (done) break;
  
  const chunk = decoder.decode(value);
  const lines = chunk.split('\n');
  
  for (const line of lines) {
    if (line.startsWith('data: ')) {
      const data = line.substring(6);
      if (data === '[DONE]') {
        // Stream complete
      } else {
        const parsed = JSON.parse(data);
        if (parsed.token) {
          // Append token to display
        }
      }
    }
  }
}
```

---

## Testing Commands

### Test Search Counter Flow
```bash
# 1. Check initial status
curl https://ria-hunter.app/api/session/status

# 2. Make a search (saves cookies)
curl -X POST https://ria-hunter.app/api/ask \
  -H "Content-Type: application/json" \
  -d '{"query":"test"}' \
  --cookie-jar cookies.txt

# 3. Check status again (with cookies)
curl https://ria-hunter.app/api/session/status \
  --cookie cookies.txt
```

---

## Summary for Frontend Team

### ‚úÖ What's Working:
1. **All endpoints are functional** at `/api/*`
2. **Session counting works** - decrements correctly
3. **Semantic search works** - returns relevant results
4. **Data fields are correct** - showing real AUM, not VC data
5. **Streaming works** - proper SSE implementation

### ‚ùå What Frontend Needs to Fix:
1. **Use correct URL prefix:** `/api/*` in production
2. **Include credentials:** Add `credentials: 'include'` to all fetch calls
3. **Handle cookies properly:** Let browser manage the httpOnly cookies
4. **Check session status:** Before allowing searches, check remaining count
5. **Handle 402 errors:** Show upgrade prompt when limit reached

### üéØ Key Points:
- The backend is **100% functional**
- The routing issue is **resolved** (use `/api/*`)
- Session tracking **works perfectly** with cookies
- The data returned is **accurate** (real AUM values)

---

## Contact

For backend issues, please document:
1. The exact URL being called
2. Request headers and body
3. Response status and body
4. Any browser console errors

The backend is fully operational. Most issues are likely frontend integration problems.
